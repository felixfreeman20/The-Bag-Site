<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAFF | THE BAG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #020617; color: white; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-active { background: #ef4444; box-shadow: 0 0 15px #ef4444; }
    </style>
</head>
<body class="p-8">
    <nav class="flex justify-between items-center mb-12">
        <h1 class="text-3xl font-black text-blue-500 uppercase italic">Staff HQ</h1>
        <div class="flex gap-4">
            <button id="flash-toggle" onclick="toggleFlash()" class="bg-slate-700 px-6 py-3 rounded-xl font-black text-[10px] uppercase">Start Flash Sale</button>
            <button onclick="toggleStore()" id="status-btn" class="px-6 py-3 rounded-xl font-black text-[10px] uppercase bg-green-500">Open</button>
        </div>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-8 space-y-6" id="order-list"></div>
        <div class="lg:col-span-4">
            <div class="glass p-8 rounded-[3rem]">
                <h2 class="text-4xl font-black mb-6" id="rev">0‡∏ø</h2>
                <div id="stock-list" class="space-y-3 mb-6"></div>
                <button onclick="saveStock()" class="w-full bg-blue-600 py-4 rounded-xl font-black">Update Stock</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAFGoJyyvtspQSauHUrWvSBWNF2taGJOYE", databaseURL: "https://thebagsite-default-rtdb.asia-southeast1.firebasedatabase.app/", projectId: "thebagsite" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const itemIds = ['squid_l_red','squid_l_orange','squid_g','squid_o','squid_r','doritos','pocky','oreo','lays_s','lays_n','gummy','gum'];
        let isFlash = false;

        db.ref('settings/flashSale').on('value', snap => {
            isFlash = snap.val()?.active && snap.val()?.end > Date.now();
            const btn = document.getElementById('flash-toggle');
            btn.innerText = isFlash ? "Stop Flash Sale" : "Start Flash Sale";
            btn.classList.toggle('btn-active', isFlash);
        });

        function toggleFlash() {
            if(isFlash) db.ref('settings/flashSale/active').set(false);
            else db.ref('settings/flashSale').set({ active: true, end: Date.now() + 900000 });
        }

        db.ref('orders').on('value', snap => {
            const list = document.getElementById('order-list'); list.innerHTML = "";
            const orders = snap.val() || {};
            Object.keys(orders).filter(k => orders[k].status === 'active').reverse().forEach(id => {
                const o = orders[id];
                list.innerHTML += `<div class="glass p-8 rounded-[2.5rem] relative">
                    <button onclick="cancelOrder('${id}')" class="absolute top-6 right-6 text-slate-500 hover:text-red-500 font-bold">CANCEL</button>
                    <p class="font-black text-xl">${o.name} <span class="text-blue-500 text-xs">${o.grade}</span></p>
                    <p class="text-sm text-slate-300 my-3 bg-white/5 p-4 rounded-xl">${o.items}</p>
                    <p class="text-xs font-bold text-cyan-400 mb-6 italic">üìç ${o.loc}</p>
                    <button onclick="bank('${id}', ${o.total})" class="w-full bg-green-600 py-4 rounded-xl font-black">Bank ${o.total}‡∏ø</button>
                </div>`;
            });
        });

        async function bank(id, amt) {
            const rSnap = await db.ref('lifetime_revenue').once('value');
            await db.ref('lifetime_revenue').set((rSnap.val() || 0) + amt);
            db.ref('orders/' + id).remove();
        }

        async function cancelOrder(id) {
            if(!confirm("Decline this order?")) return;
            const oSnap = await db.ref('orders/' + id).once('value');
            const o = oSnap.val(); const sSnap = await db.ref('stock').once('value');
            const s = sSnap.val(); let up = {};
            for(let i in o.rawItems) up[`/stock/${i}`] = (s[i] || 0) + o.rawItems[i];
            await db.ref().update(up);
            await db.ref('orders/' + id).update({ status: 'cancelled' });
            setTimeout(() => db.ref('orders/' + id).remove(), 4000);
        }

        db.ref('stock').on('value', snap => {
            const s = snap.val() || {}; const l = document.getElementById('stock-list'); l.innerHTML = "";
            itemIds.forEach(id => {
                l.innerHTML += `<div class="flex justify-between items-center bg-white/5 p-2 rounded-lg">
                    <span class="text-[10px] uppercase font-bold">${id.replace(/_/g,' ')}</span>
                    <input type="number" id="in-${id}" value="${s[id]||0}" class="w-12 bg-blue-900 text-center rounded">
                </div>`;
            });
        });

        function saveStock() { let s = {}; itemIds.forEach(id => s[id] = parseInt(document.getElementById('in-'+id).value)||0); db.ref('stock').set(s); }
        function toggleStore() { db.ref('settings/isOpen').once('value', s => db.ref('settings/isOpen').set(!s.val())); }
        db.ref('lifetime_revenue').on('value', s => document.getElementById('rev').innerText = (s.val()||0) + "‡∏ø");
    </script>
</body>
</html>
