<script>
    const firebaseConfig = { apiKey: "AIzaSyAFGoJyyvtspQSauHUrWvSBWNF2taGJOYE", databaseURL: "https://thebagsite-default-rtdb.asia-southeast1.firebasedatabase.app/", projectId: "thebagsite" };
    firebase.initializeApp(firebaseConfig); const db = firebase.database();
    
    let cart = {}, stock = {}, isFlash = false, method = "Pickup", bestSellerId = "";
    let flashInterval = null; // Added to track timer

    db.ref('settings/storeOpen').on('value', snap => {
        const isOpen = snap.val();
        document.getElementById('closed-screen').classList.toggle('hidden', isOpen);
    });

    db.ref('orders').on('value', snap => {
        const orders = snap.val() || {};
        const counts = {};
        const fourHoursAgo = Date.now() - (4 * 60 * 60 * 1000);
        Object.values(orders).forEach(o => {
            if(o.timestamp > fourHoursAgo && o.items_list) {
                o.items_list.forEach(id => { counts[id] = (counts[id] || 0) + 1; });
            }
        });
        bestSellerId = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, "");
        renderInventory();
    });
    
    const itemsData = {
        squid_l_red: { name: "Large Squid (Red)", price: 35, img: "squid_l_red.png" },
        squid_l_orange: { name: "Large Squid (Orange)", price: 35, img: "squid_l_orange.png" },
        squid_g: { name: "Small Squid (Green)", price: 15, img: "squid_g.png" },
        squid_o: { name: "Small Squid (Orange)", price: 15, img: "squid_o.png" },
        squid_r: { name: "Small Squid (Red)", price: 15, img: "squid_r.png" },
        doritos: { name: "Cheese Doritos", price: 30, img: "doritos.png" },
        pocky: { name: "Pocky Choco", price: 35, img: "pocky.png" },
        oreo: { name: "Oreo Pack", price: 15, img: "oreo.png" },
        lays_s: { name: "Lays Seaweed", price: 15, img: "lays_s.png" },
        lays_n: { name: "Lays Normal", price: 15, img: "lays_n.png" },
        gummy: { name: "Gummy Bears", price: 30, img: "gummy.png" },
        gum: { name: "Chewing Gum", price: 30, img: "gum.png" }
    };

    const pop = document.getElementById('pop-sfx');
    document.addEventListener('click', () => { pop.play().then(() => { pop.pause(); pop.currentTime = 0; }); }, { once: true });
    function playPop() { pop.currentTime = 0; pop.play().catch(()=>{}); }
    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); }

    db.ref('settings/flashSale').on('value', snap => {
        const data = snap.val() || {}; 
        isFlash = data.active && data.end > Date.now();
        
        // FIX: Clear existing interval to stop timer glitching
        if(flashInterval) clearInterval(flashInterval);

        document.body.classList.toggle('flash-active', isFlash);
        document.getElementById('flash-timer-box').classList.toggle('hidden', !isFlash);
        document.getElementById('total-sale-tag').classList.toggle('hidden', !isFlash);
        
        if(isFlash) { 
            const updateTimer = () => {
                const diff = data.end - Date.now();
                if(diff <= 0) {
                    clearInterval(flashInterval);
                    document.getElementById('flash-timer-box').classList.add('hidden');
                    return;
                }
                const m = Math.floor(diff/60000), s = Math.floor((diff%60000)/1000);
                document.getElementById('timer-display').innerText = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            };
            updateTimer();
            flashInterval = setInterval(updateTimer, 1000); 
        }
        renderInventory();
        updateCartDisplay();
    });

    db.ref('stock').on('value', snap => { stock = snap.val() || {}; renderInventory(); });

    function renderInventory() {
        const container = document.getElementById('inventory'); container.innerHTML = "";
        Object.keys(itemsData).forEach(id => {
            const s = stock[id] || 0; 
            const p = isFlash ? Math.floor(itemsData[id].price * 0.9) : itemsData[id].price;
            container.innerHTML += `
            <div class="bg-card p-4 rounded-[2.5rem] flex items-center gap-4 ${s <= 0 ? 'opacity-30 grayscale pointer-events-none' : ''}">
                <img src="${itemsData[id].img}" class="snack-img">
                <div class="flex-1">
                    <div class="flex gap-2 mb-1">
                        ${s <= 2 && s > 0 ? '<span class="bg-red-500 text-white text-[8px] px-2 py-0.5 rounded-full font-black animate-bounce">BUY NOW (Only '+s+')</span>' : ''}
                        ${id === bestSellerId ? '<span class="bg-blue-600 text-white text-[8px] px-2 py-0.5 rounded-full font-black uppercase">Popular</span>' : ''}
                    </div>
                    <h3 class="font-black text-sm uppercase italic">${itemsData[id].name}</h3>
                    <div class="flex items-center gap-2">
                       <p class="font-black text-lg" style="color:var(--accent)">${p}à¸¿</p>
                       ${isFlash ? '<span class="text-[9px] bg-red-600 text-white px-1.5 py-0.5 rounded-md font-black italic">-10%</span>' : ''}
                    </div>
                    <p class="text-[10px] font-black opacity-40 uppercase tracking-tighter">Stock: ${s}</p>
                </div>
                <div class="flex items-center gap-3 bg-slate-500/10 p-2 rounded-2xl">
                    <button onclick="updateQty('${id}',-1);playPop()" class="w-8 h-8 font-black">-</button>
                    <span class="font-black">${cart[id] || 0}</span>
                    <button onclick="updateQty('${id}',1);playPop()" class="w-8 h-8 font-black">+</button>
                </div>
            </div>`;
        });
    }

    function updateQty(id, amt) {
        cart[id] = Math.max(0, Math.min(stock[id], (cart[id] || 0) + amt));
        updateCartDisplay(); renderInventory();
    }

    function updateCartDisplay() {
        let t = (method === "Delivery" ? 15 : 0);
        Object.keys(cart).forEach(k => t += (cart[k] || 0) * (isFlash ? Math.floor(itemsData[k].price * 0.9) : itemsData[k].price));
        document.getElementById('total-val').innerText = t + " THB";
    }

    function setMethod(m) { 
        method = m; 
        document.getElementById('btn-p').style.background = m === 'Pickup' ? 'var(--accent)' : 'transparent';
        document.getElementById('btn-p').style.color = m === 'Pickup' ? 'white' : 'inherit';
        document.getElementById('btn-d').style.background = m === 'Delivery' ? 'var(--accent)' : 'transparent';
        document.getElementById('btn-d').style.color = m === 'Delivery' ? 'white' : 'inherit';
        updateCartDisplay();
    }

    async function submitOrder() {
        const n = document.getElementById('cust-name').value;
        const itemsInCart = Object.keys(cart).filter(k=>cart[k]>0);
        if(!n || itemsInCart.length === 0) return alert("Add items and name!");
        const snap = await db.ref('orders').once('value');
        const active = Object.values(snap.val() || {}).filter(o => o.status === 'active').length;
        const wait = (active * 3) + 5;
        const itemsListForBestSeller = [];
        itemsInCart.forEach(id => {
            const qty = cart[id];
            for(let i=0; i<qty; i++) itemsListForBestSeller.push(id);
            db.ref('stock/'+id).transaction(current => (current || 0) - qty);
        });
        const ref = await db.ref('orders').push({ 
            name: n, grade: document.getElementById('cust-grade').value, 
            items: itemsInCart.map(k=>`${itemsData[k].name} x${cart[k]}`).join(', '),
            items_list: itemsListForBestSeller,
            status: 'active', timestamp: Date.now(), location: method
        });
        document.getElementById('order-flow').classList.add('hidden');
        document.getElementById('bottom-bar').classList.add('hidden');
        document.getElementById('receipt').classList.remove('hidden');
        document.getElementById('wait-time').innerText = wait + " mins";
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        db.ref('orders/'+ref.key).on('value', s => { if(s.val()?.status === 'cancelled') document.getElementById('full-cancel-screen').classList.remove('hidden'); });
    }
</script>
