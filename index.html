<script>
    const firebaseConfig = { apiKey: "AIzaSyAFGoJyyvtspQSauHUrWvSBWNF2taGJOYE", databaseURL: "https://thebagsite-default-rtdb.asia-southeast1.firebasedatabase.app/", projectId: "thebagsite" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const itemsData = {
        squid_l: { name: "Spicy Squid (L)", price: 35 }, doritos: { name: "Cheese Doritos", price: 30 },
        squid_g: { name: "Small Squid (Green)", price: 15 }, squid_o: { name: "Small Squid (Orange)", price: 15 },
        squid_r: { name: "Small Squid (Red)", price: 15 }, pocky: { name: "Pocky Choco", price: 35 },
        oreo: { name: "Oreo Pack", price: 15 }, lays_s: { name: "Lays Seaweed", price: 15 },
        lays_n: { name: "Lays Normal", price: 15 }, gummy: { name: "Gummy Bears", price: 30 }, gum: { name: "Chewing Gum", price: 30 }
    };

    let cart = {}, stock = {}, method = "Pickup", deliveryFee = 0, activeOrderCount = 0;

    // 1. Monitor Queue Size
    db.ref('orders').on('value', (snap) => {
        const orders = snap.val();
        activeOrderCount = orders ? Object.keys(orders).length : 0;
    });

    db.ref('settings/isOpen').on('value', (snap) => {
        const open = snap.val();
        document.getElementById('store-content').classList.toggle('hidden', !open);
        document.getElementById('bottom-bar').classList.toggle('hidden', !open);
        document.getElementById('closed-message').classList.toggle('hidden', open);
    });

    function setMethod(m) {
        method = m; deliveryFee = (m === "Delivery") ? 15 : 0;
        document.getElementById('btn-pickup').className = m === "Pickup" ? "flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow-sm flex flex-col items-center" : "flex-1 py-3 rounded-xl font-bold text-sm text-slate-500 flex flex-col items-center";
        document.getElementById('btn-delivery').className = m === "Delivery" ? "flex-1 py-3 rounded-xl font-bold text-sm bg-white shadow-sm" : "flex-1 py-3 rounded-xl font-bold text-sm text-slate-500";
        document.getElementById('loc-container').classList.toggle('hidden', m !== 'Delivery');
        updateCartDisplay();
    }

    db.ref('stock').on('value', (snap) => { stock = snap.val() || {}; renderInventory(); });

    function renderInventory() {
        const container = document.getElementById('inventory-container'); container.innerHTML = "";
        for (let id in itemsData) {
            const s = stock[id] || 0;
            container.innerHTML += `
                <div class="snack-card bg-white p-6 rounded-[2rem] shadow-sm flex justify-between items-center ${s <= 0 ? 'sold-out' : ''}">
                    <div><h3 class="font-bold text-slate-800 text-lg">${itemsData[id].name}</h3><p class="text-blue-600 font-black">${itemsData[id].price} THB <span class="text-slate-400 text-[10px] ml-2 font-bold uppercase">${s <= 0 ? 'SOLD OUT' : 'Stock: '+s}</span></p></div>
                    <div class="flex items-center gap-4 bg-slate-50 p-1.5 rounded-2xl border border-slate-100">
                        <button onclick="updateQty('${id}', -1)" class="w-10 h-10 bg-white rounded-xl shadow-sm font-bold">-</button>
                        <span id="${id}-qty" class="text-lg font-black w-6 text-center text-blue-600">${cart[id] || 0}</span>
                        <button onclick="updateQty('${id}', 1)" class="w-10 h-10 bg-white rounded-xl shadow-sm font-bold" ${s <= (cart[id]||0) ? 'disabled' : ''}>+</button>
                    </div>
                </div>`;
        }
    }

    function updateQty(id, amt) {
        cart[id] = Math.max(0, Math.min(stock[id], (cart[id] || 0) + amt));
        document.getElementById(id + '-qty').innerText = cart[id];
        updateCartDisplay();
    }

    function updateCartDisplay() {
        let total = deliveryFee;
        for (let id in cart) total += (cart[id] * itemsData[id].price);
        document.getElementById('total-display').innerText = total + " THB";
    }

    function showRules() {
        if(!document.getElementById('cust-name').value) return alert("Enter your name!");
        if(method === 'Delivery' && !document.getElementById('cust-loc').value) return alert("Enter location!");
        document.getElementById('rules-modal').classList.remove('hidden');
    }

    async function submitOrder() {
        const btn = document.getElementById('final-buy-btn');
        btn.disabled = true; btn.innerText = "Securing...";

        const freshSnap = await db.ref('stock').once('value');
        const fs = freshSnap.val() || {};
        for(let id in cart) if(cart[id] > (fs[id] || 0)) { alert("Something sold out! Page refreshing..."); location.reload(); return; }

        let itemsArr = [], updates = {}, total = deliveryFee;
        for(let id in cart) if(cart[id] > 0) {
            itemsArr.push(`${itemsData[id].name} x${cart[id]}`);
            updates[`/stock/${id}`] = fs[id] - cart[id];
            total += (cart[id] * itemsData[id].price);
        }
        
        const name = document.getElementById('cust-name').value;
        const finalLoc = (method === 'Pickup') ? "The Falcons Nest (Cafe Area)" : document.getElementById('cust-loc').value;

        const order = { name, grade: document.getElementById('cust-grade').value || "N/A", loc: finalLoc, items: itemsArr.join(', '), total, method, timestamp: Date.now() };

        const newOrderRef = await db.ref('orders').push(order);
        await db.ref().update(updates);

        // --- DYNAMIC WAIT TIME CALCULATION ---
        // 0 orders = 2 mins, 1-2 orders = 4 mins, 3-5 orders = 6 mins, 6+ orders = 9 mins
        let calculatedWait = 2;
        if (activeOrderCount >= 1 && activeOrderCount <= 2) calculatedWait = 4;
        else if (activeOrderCount >= 3 && activeOrderCount <= 5) calculatedWait = 6;
        else if (activeOrderCount > 5) calculatedWait = 9;

        // SHOW RECEIPT
        document.getElementById('order-flow').classList.add('hidden');
        document.getElementById('bottom-bar').classList.add('hidden');
        document.getElementById('rules-modal').classList.add('hidden');
        document.getElementById('main-nav').classList.add('hidden');
        
        document.getElementById('receipt-id').innerText = "ID: #" + newOrderRef.key.slice(-5).toUpperCase();
        document.getElementById('receipt-total').innerText = total + "à¸¿";
        document.getElementById('receipt-items').innerText = itemsArr.join(', ');
        document.getElementById('receipt-location').innerText = finalLoc;
        document.getElementById('est-time').innerText = calculatedWait + " mins";
        
        document.getElementById('receipt-page').classList.remove('hidden');
        window.scrollTo(0,0);
    }
</script>
